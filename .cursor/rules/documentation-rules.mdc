---
description: Fitliyo Backend DokÃ¼mantasyon KurallarÄ± (docs/ + swagger snapshot)
globs:
alwaysApply: true
---

# DokÃ¼mantasyon KurallarÄ± (Backend)

## 1) Tek Kaynak Prensibi (ZORUNLU)

- **Tek dokÃ¼mantasyon giriÅŸi**: `docs/README.md`
- Repo kÃ¶kÃ¼nde **yalnÄ±zca** `README.md` bulunur ve bu dosya **kÄ±sa landing page**â€™dir.
- DetaylÄ± tÃ¼m dokÃ¼mantasyon **`docs/` altÄ±nda** tutulur.

## 2) Kod DeÄŸiÅŸirse DokÃ¼man DeÄŸiÅŸir (ZORUNLU)

Bir PR aÅŸaÄŸÄ±dakilerden herhangi birini iÃ§eriyorsa ilgili dokÃ¼man(lar) **zorunlu** gÃ¼ncellenir:

- **Yeni endpoint** / endpoint deÄŸiÅŸikliÄŸi
- **DTO deÄŸiÅŸikliÄŸi** (field ekleme/silme/nullable deÄŸiÅŸimi/validation)
- **Permission/Authorization deÄŸiÅŸikliÄŸi**
- **Multi-tenant / SubTenant davranÄ±ÅŸÄ±**
- **Cache davranÄ±ÅŸÄ±** (TTL/invalidation/key pattern)
- **Error code / exception mapping**
- **Background job davranÄ±ÅŸÄ±**
- **Deployment/operasyon** deÄŸiÅŸikliÄŸi

## 3) API SÃ¶zleÅŸmesi: "Birebir" KuralÄ± (UI iÃ§in kritik)

- AppService dokÃ¼manlarÄ±nÄ±n **endpoint / parametre / request / response / model** bÃ¶lÃ¼mleri **tahmin edilmez**.
- **Tek doÄŸruluk kaynaÄŸÄ±**: `docs/openapi/swagger.web.v1.full.json`
- UI repo/assets altÄ±ndaki swagger Ã§Ä±ktÄ±larÄ± **kaynak deÄŸildir**.

### 3.1) Dinamik Alan DokÃ¼mantasyonu (KRÄ°TÄ°K)

AppService dokÃ¼manlarÄ± oluÅŸturulurken/gÃ¼ncellenirken:

- **Swagger'da gÃ¶rÃ¼nmeyen dinamik alanlar tespit edilmeli ve dokÃ¼mante edilmeli**
- `SetProperty()` ile DTO'lara eklenen alanlar belirtilmeli
- `ExtraProperties` iÃ§ine eklenen tÃ¼m alanlar listelenmeli
- UserEnricher gibi zenginleÅŸtirme servisleri ile eklenen veriler aÃ§Ä±klanmalÄ±
- Stored Procedure'lerden gelen dinamik veriler dokÃ¼mante edilmeli

**Ã–rnek Dinamik Alanlar:**
- TrainerProfileDto'ya eklenen: `AverageRating`, `TotalReviewCount`
- ZenginleÅŸtirme verileri: `Categories`, `SpecialtyTags`
- Ä°liÅŸkili veriler: `TrainerCertificates`, `TrainerGallery`
- Detay bilgiler: `ServicePackages`, `AvailabilitySchedule`

Bu alanlar swagger'da gÃ¶rÃ¼nmese bile, kod analizi yapÄ±larak tespit edilip dokÃ¼mante edilmelidir.

### 3.2) Dinamik Alan Eklenmesi â†’ Frontend DeÄŸiÅŸiklik Takibi (ZORUNLU)

`SetProperty()` veya `ExtraProperties` Ã¼zerinden **yeni bir alan eklendiÄŸinde** aÅŸaÄŸÄ±daki adÄ±mlar zorunludur:

1. AppService dokÃ¼manÄ±nda ilgili response tablosuna ğŸ†• etiketiyle ekle
2. `docs/frontend-changes/YYYY-MM-DD-N.md` oluÅŸtur (`track-frontend-change` komutu)
3. `docs/CHANGELOG.md` gÃ¼ncelle

Bu alanlar Swagger'da gÃ¶rÃ¼nmez; frontend ekibi ancak bu takip dosyalarÄ±ndan haberdar olabilir.

```csharp
// Bu satÄ±r â†’ zorunlu olarak frontend-changes dosyasÄ± gerektirir
entity.SetProperty("SgkJobCode", value);
```

## 4) Swagger Snapshot Ãœretimi (ZORUNLU)

API sÃ¶zleÅŸmesi deÄŸiÅŸtiyse veya AppService dokÃ¼manlarÄ± gÃ¼ncellenecekse Ã¶nce:

```bash
# Repo rootâ€™tan Ã§alÄ±ÅŸtÄ±rÄ±n
dotnet run --project src/Fitliyo.Web -- --generate-swagger docs/openapi/swagger.web.v1.full.json
```

> **UyarÄ±:** Bu komut `Fitliyo.Web` modÃ¼llerini initialize eder. Development ortamÄ±nda hangi DB/servislere baÄŸlandÄ±ÄŸÄ±nÄ±za dikkat edin.

## 5) AppService DokÃ¼manlarÄ±nÄ± Ãœretme (ZORUNLU)

**`src/Fitliyo.Application/**/*AppService.cs` deÄŸiÅŸtiÄŸinde dokÃ¼man yenileme ZORUNLUDUR.**

```bash
python3 scripts/generate_appservice_docs.py
```

- `docs/app-services/*.md` dosyalarÄ± **generator Ã§Ä±ktÄ±sÄ±dÄ±r**.
- Manuel edit yapÄ±lacaksa Ã¶nce generator gÃ¼ncellenmeli, sonra tekrar Ã¼retilmelidir.
- **Otomatik tetikleme:** AppService dosyasÄ± dÃ¼zenlendiÄŸinde (commit Ã¶ncesi veya dÃ¼zenleme bitiminde) bu script AI tarafÄ±ndan **otomatik Ã§alÄ±ÅŸtÄ±rÄ±lmalÄ±dÄ±r**.

## 6) Versiyonlama ve Changelog (ZORUNLU)

- Versiyon standardÄ±: [`docs/VERSIONING.md`](../../docs/VERSIONING.md)
- Her anlamlÄ± dokÃ¼man deÄŸiÅŸikliÄŸinde: [`docs/CHANGELOG.md`](../../docs/CHANGELOG.md) gÃ¼ncellenir.
- Ä°stemciyi etkileyen deÄŸiÅŸikliklerde: [`docs/BACKEND_CHANGES_FOR_FRONTEND_TEAM.md`](../../docs/BACKEND_CHANGES_FOR_FRONTEND_TEAM.md) gÃ¼ncellenir.

## 7) Dil ve Format

- DokÃ¼mantasyon dili: **TÃ¼rkÃ§e**
- Kod Ã¶rnekleri: kÄ±sa ve kopyalanabilir
- **ğŸ†• DokÃ¼manlararasÄ± Linkler (ZORUNLU)**:
  - DiÄŸer dokÃ¼manlara referans verirken **mutlaka tÄ±klanabilir link** formatÄ± kullanÄ±lmalÄ±
  - Format: `[DokÃ¼mantasyon AdÄ±](yol/dosya.md)`
  - Ã–rnek: `[CHANGELOG](../../docs/CHANGELOG.md)`, `[Yetkilendirme Sistemi](../../docs/AUTHORIZATION-SYSTEM.md)`
  - Sadece dosya adÄ± yazÄ±lmamalÄ±, mutlaka link formatÄ±nda olmalÄ±
  - Relative path kullanÄ±lmalÄ± (docs/... veya ../ ÅŸeklinde)
- **Yeni Eklenen Ä°Ã§erikler**: ğŸ†• (NEW) tag'i ile iÅŸaretlenmeli
  - Yeni endpoint'ler
  - Yeni alanlar (dinamik olarak eklenenler dahil)
  - Yeni kurallar veya deÄŸiÅŸiklikler
  - Son gÃ¼ncelleme tarihinden sonra eklenenler

## ğŸ†• 8) Yetkilendirme DokÃ¼mantasyonu (ZORUNLU)

**HER** AppService dokÃ¼manÄ±nda (`docs/app-services/*.md`) **Yetkilendirme Matrisi** bÃ¶lÃ¼mÃ¼ (1.1) **zorunlu** olarak bulunmalÄ±dÄ±r:

### 8.1) Yetkilendirme Matrisi Ä°Ã§eriÄŸi

Her AppService dokÃ¼manÄ±nÄ±n "Kod MetodlarÄ±" bÃ¶lÃ¼mÃ¼nÃ¼n hemen altÄ±nda (BÃ¶lÃ¼m 1.1) ÅŸu tablo yer almalÄ±dÄ±r:

| Method | Yetkilendirme | Self-Access | AÃ§Ä±klama |
|--------|---------------|-------------|----------|

Bu tabloda:
- **TÃ¼m public method'lar** listelenmeli (CRUD + Ã¶zel method'lar)
- **Class-level** `[Authorize]` bilgisi tablonun Ã¼stÃ¼nde belirtilmeli
- **Method-level** `[Authorize(FitliyoPermissions.XXX)]` override'larÄ± gÃ¶sterilmeli
- **`[AllowSelfAccess]`** attribute'leri ve parametreleri (`userId`, `UserId`, `Module` bilgisi) gÃ¶sterilmeli
- **`[AllowAnonymous]`** varsa aÃ§Ä±kÃ§a belirtilmeli
- **Constructor policy** (GetPolicyName, GetListPolicyName vb.) varsa belirtilmeli

### 8.2) Frontend PlanÄ± DokÃ¼manlarÄ±nda Yetkilendirme (ZORUNLU)

Frontend planÄ±/iÅŸ planÄ± dokÃ¼manlarÄ±nda (`docs/*_FRONTEND_PLANI.md` vb.) ÅŸunlar **zorunlu**:
- **Tab/sayfa Ã¶zet tablosunda** yetkilendirme sÃ¼tunu olmalÄ± (boÅŸ bÄ±rakÄ±lmamalÄ±)
- **Her tab/bÃ¶lÃ¼m baÅŸlÄ±ÄŸÄ±nÄ±n altÄ±nda** `**Yetkilendirme:**` satÄ±rÄ± bulunmalÄ±
- `[Authorize]` (policysiz) olan endpoint'ler bile "sadece authenticated" olarak belirtilmeli
- **Lookup endpoint tablosunda** yetkilendirme sÃ¼tunu bulunmalÄ±
- "-" yerine gerÃ§ek yetkilendirme bilgisi yazÄ±lmalÄ±; yetki yoksa `[AllowAnonymous]` veya `[Authorize]` (policysiz) olarak aÃ§Ä±kÃ§a belirtilmeli

### 8.3) Yetkilendirme Bilgisinin KaynaÄŸÄ±

Yetkilendirme bilgisi **koddan** tespit edilmelidir, **tahmin edilmez**:
- `src/Fitliyo.Application/` altÄ±ndaki AppService dosyalarÄ± okunmalÄ±
- Class-level ve method-level `[Authorize]` attribute'leri tespit edilmeli
- Constructor'daki policy atamalarÄ± (GetPolicyName, CreatePolicyName vb.) kontrol edilmeli
- `[AllowSelfAccess]` ve `[AllowAnonymous]` attribute'leri tespit edilmeli

## 9) PR Kontrol Listesi (Minimum)

- `docs/openapi/swagger.web.v1.full.json` gÃ¼ncel mi?
- `docs/app-services/*.md` yeniden Ã¼retildi mi?
- `docs/CHANGELOG.md` gÃ¼ncellendi mi? **(HER DEÄÄ°ÅÄ°KLÄ°K Ä°Ã‡Ä°N ZORUNLU)**
- Error format/permission/caching deÄŸiÅŸtiyse ilgili standart dokÃ¼man gÃ¼ncellendi mi?
- ğŸ†• **AppService dokÃ¼manlarÄ±nda Yetkilendirme Matrisi (BÃ¶lÃ¼m 1.1) var mÄ±?**
- ğŸ†• **Frontend planÄ± dokÃ¼manlarÄ±nda yetkilendirme bilgisi eksiksiz mi?**
- ğŸ†• **Proje yapÄ±sÄ±/stack/komutlar deÄŸiÅŸtiyse `README.md` (proje kÃ¶kÃ¼) gÃ¼ncellendi mi?**

## 10) CHANGELOG GÃ¼ncelleme KuralÄ± (ZORUNLU)

**HER** kod deÄŸiÅŸikliÄŸi, kural deÄŸiÅŸikliÄŸi veya dokÃ¼mantasyon gÃ¼ncellemesi [`docs/CHANGELOG.md`](../../docs/CHANGELOG.md) dosyasÄ±na eklenmelidir:

> **AylÄ±k ArÅŸivleme:** Aktif ay `docs/CHANGELOG.md`'de, eski aylar [`docs/changelog/`](../../docs/changelog/) altÄ±nda `YYYY-MM.md` dosyalarÄ±nda tutulur. Her ay sonunda: `python3 scripts/archive_changelog.py`

- Kod deÄŸiÅŸiklikleri (yeni Ã¶zellik, bug fix, refactoring)
- DokÃ¼mantasyon gÃ¼ncellemeleri (manuel veya otomatik)
- Kural deÄŸiÅŸiklikleri (.cursorrules, .cursor/rules/)
- API sÃ¶zleÅŸmesi deÄŸiÅŸiklikleri
- KonfigÃ¼rasyon deÄŸiÅŸiklikleri

### ğŸ†• 10.1) CHANGELOG Organizasyon KuralÄ±

**CHANGELOG'da detay vermek yerine ilgili dokÃ¼mana yÃ¶nlendirme yapÄ±lmalÄ±:**

- **YanlÄ±ÅŸ**: UserEnricher.cs dosyasÄ±nda GetEnrichmentDataAsync metodu gÃ¼ncellendi, userId ve roleNames alanlarÄ± hem bÃ¼yÃ¼k hem kÃ¼Ã§Ã¼k harfle gÃ¶nderiliyor...
- **DoÄŸru**: UserEnricher zenginleÅŸtirmeleri gÃ¼ncellendi. Detaylar: [`FitliyoProfileAppService.md`](../../docs/app-services/FitliyoProfileAppService.md)

**Teknik detaylar ilgili AppService dokÃ¼manÄ±nda tutulmalÄ±:**
- Kod deÄŸiÅŸikliÄŸi detaylarÄ±
- Dinamik alan eklemeleri
- Method gÃ¼ncellemeleri
- Implementation notlarÄ±

**ğŸ†• AppService DokÃ¼man SÄ±ralamasÄ±:**
1. Kod MetodlarÄ± (sadece imza, detay yok)
2. **ğŸ†• Yetkilendirme Matrisi** (tÃ¼m method'larÄ±n yetki bilgisi â€” BÃ¶lÃ¼m 1.1)
3. Endpoint Listesi
4. Request/Response Modelleri
5. DeÄŸiÅŸiklik GeÃ§miÅŸi (tarih ile, yeniden eskiye, UI odaklÄ±)
6. Referanslar

**ğŸ†• DeÄŸiÅŸiklik GeÃ§miÅŸi KurallarÄ±:**
- Backend metod/class isimleri yazÄ±lmaz
- Sadece UI'Ä± etkileyen deÄŸiÅŸiklikler yazÄ±lÄ±r
- Ne deÄŸiÅŸti ve UI'da nasÄ±l kullanÄ±lÄ±yor odaklÄ± olmalÄ±
- KÄ±sa, net, UI developer'a yÃ¶nelik

**CHANGELOG'da sadece Ã¶zet ve link olmalÄ±:**
- Ne deÄŸiÅŸti (genel Ã¶zet)
- Hangi servisi/modÃ¼lÃ¼ etkiliyor
- Detaylar iÃ§in hangi dokÃ¼mana bakÄ±lmalÄ± (link ile)

## 11) Frontend Team (Next.js) DeÄŸiÅŸiklik Bildirimi (ZORUNLU)

**YALNIZCA Next.js frontend ekibini etkileyen** API/DTO/SignalR deÄŸiÅŸiklikleri `docs/frontend-changes/` klasÃ¶rÃ¼ne ayrÄ± dosya olarak eklenmelidir.

**KAPSAM (KRÄ°TÄ°K):** MVC Razor Pages, MVC JavaScript dosyalarÄ± ve sadece backend'i etkileyen deÄŸiÅŸiklikler bu klasÃ¶re **EKLENMEz**.

**DetaylÄ± standart, format, badge'ler ve adÄ±mlar:** â†’ bkz. [frontend-change-tracking.mdc](frontend-change-tracking.mdc)

### Skill ReferanslarÄ±

- [DokÃ¼mantasyon KurallarÄ±](../../.claude/skills/documentation-practices/SKILL.md) â€” dokÃ¼mantasyon kurallarÄ± Ã¶zeti
- [DetaylÄ± Kurallar](../../.claude/skills/documentation-practices/references/rules.md) â€” CHANGELOG, endpoint kontrol, dynamic field detaylarÄ±
